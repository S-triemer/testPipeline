name: Deploy to Portainer

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Login to Docker Registry
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }} ghcr.io

      - name: Build and Push docker image
        run: |
          docker build -t ghcr.io/s-triemer/my-image:latest .
          docker push ghcr.io/s-triemer/my-image:latest
      - name: SSH into Portainer Host
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PORTAINER_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
        script: |
        ssh -N -L 9000:localhost:9000 -o StrictHostKeyChecking=no -i <(echo "${{ secrets.SSH_KEY }}") ${{ secrets.SSH_USERNAME }}@${{ secrets.PORTAINER_HOST }} &
        sleep 5
        docker pull ghcr.io/s-triemer/my-image:latest
        docker stop my_container || true
        docker rm my_container || true
        docker run -d --name my_container -p 8080:80 ghcr.io/s-triemer/my-image:latest
